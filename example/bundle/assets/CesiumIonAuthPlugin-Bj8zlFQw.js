import{G as o}from"./GoogleCloudAuthPlugin-gv3hNYxX.js";class l{constructor({apiToken:e,assetId:i=null,autoRefreshToken:t=!1}){this.name="CESIUM_ION_AUTH_PLUGIN",this.apiToken=e,this.assetId=i,this.autoRefreshToken=t,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[]}init(e){this.assetId!==null&&(e.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=e,this.endpointURL=e.rootURL}loadRootTileSet(){return this._refreshToken().then(()=>this.tiles.loadRootTileSet())}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&this._tileSetVersion!=-1&&e.searchParams.append("v",this._tileSetVersion),e.toString()}fetchData(e,i){return this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")!==null?null:Promise.resolve().then(async()=>{this._tokenRefreshPromise!==null&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const s=await fetch(e,i);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(i),fetch(this.preprocessURL(e),i)):s})}getAttributions(e){this.tiles.visibleTiles.size>0&&e.push(...this._attributions)}_refreshToken(e){if(this._tokenRefreshPromise===null){const i=new URL(this.endpointURL);i.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(i,e).then(t=>{if(!t.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${t.status}`);return t.json()}).then(t=>{const s=this.tiles;if("externalType"in t){const r=new URL(t.options.url);s.rootURL=t.options.url,s.registerPlugin(new o({apiToken:r.searchParams.get("key")}))}else{if(s.rootURL=t.url,s.fetchOptions.headers=s.fetchOptions.headers||{},s.fetchOptions.headers.Authorization=`Bearer ${t.accessToken}`,i.searchParams.has("v")&&this._tileSetVersion===-1){const r=new URL(t.url);this._tileSetVersion=r.searchParams.get("v")}this._bearerToken=t.accessToken,t.attributions&&(this._attributions=t.attributions.map(r=>({value:r.html,type:"html",collapsible:r.collapsible})))}return this._tokenRefreshPromise=null,t})}return this._tokenRefreshPromise}}export{l as C};
