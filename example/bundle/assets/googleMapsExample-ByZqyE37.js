import{j as F,k as L,l as H,m as O,g as V,B as j,d as $,n as N,o as k,p as K,G as q,q as D,W as Q,S as X,a as Z,O as J,i as g}from"./three.module-DpclfMcJ.js";import{G as Y}from"./GLTFLoader-DkJa3Jo5.js";import{D as ee}from"./DRACOLoader-DJWREZh5.js";import{g as te}from"./lil-gui.module.min-Bc0DeA9g.js";import{S as ae}from"./stats.module--VATS4Kh.js";import{T as re}from"./TileCompressionPlugin-LPgvgQPx.js";import{U as ne}from"./UpdateOnChangePlugin-BFotcVNs.js";import{T as ie}from"./TilesFadePlugin-CYp6zEtB.js";import{F as se}from"./Pass-inUSP30K.js";import{T as oe}from"./TilesRenderer-3GzfWA9Z.js";import{G as de}from"./GoogleCloudAuthPlugin-gv3hNYxX.js";import{C as ce}from"./CameraTransitionManager-6Raba0ko.js";import{G as le}from"./GlobeControls-tcF-lZFC.js";import{C as B,t as he}from"./Ellipsoid-Cnb0UTwk.js";import{W as I}from"./I3DMLoader-BlebwdUJ.js";import"./B3DMLoader-B2OeBq6-.js";import"./readMagicBytes-Da5ueiou.js";import"./LoaderBase-CVSPpjX2.js";import"./PNTSLoader-BMN5TswI.js";import"./CMPTLoader-nLXQ3OXQ.js";import"./GLTFExtensionLoader-TubLlshp.js";import"./EllipsoidRegion-D6hT1syi.js";import"./EnvironmentControls-CYEuz71t.js";const me=new F,S=new L,G=new L;class ue extends H{constructor(...e){super(...e),this.resetDistance=1e4,this._matricesTextureHandle=null,this._lastCameraPos=new F,this._forceUpdate=!0}setMatrixAt(...e){super.setMatrixAt(...e),this._forceUpdate=!0}onBeforeRender(e,t,a,n,c,r){super.onBeforeRender(e,t,a,n,c,r),S.setFromMatrixPosition(a.matrixWorld),G.setFromMatrixPosition(this._lastCameraPos);const o=this._matricesTexture;let d=this._modelViewMatricesTexture;if((!d||d.image.width!==o.image.width||d.image.height!==o.image.height)&&(d&&d.dispose(),d=o.clone(),d.source=new O({...d.image,data:d.image.data.slice()}),this._modelViewMatricesTexture=d),this._forceUpdate||S.distanceTo(G)>this.resetDistance){const h=o.image.data,u=d.image.data;for(let l=0;l<this.maxInstanceCount;l++)me.fromArray(h,l*16).premultiply(this.matrixWorld).premultiply(a.matrixWorldInverse).toArray(u,l*16);d.needsUpdate=!0,this._lastCameraPos.copy(a.matrixWorld),this._forceUpdate=!1}this._matricesTextureHandle=this._matricesTexture,this._matricesTexture=this._modelViewMatricesTexture,this.matrixWorld.copy(this._lastCameraPos)}onAfterRender(){this.updateMatrixWorld(),this._matricesTexture=this._matricesTextureHandle,this._matricesTextureHandle=null}onAfterShadow(e,t,a,n,c,r){this.onAfterRender(e,null,n,c,r)}dispose(){super.dispose(),this._modelViewMatricesTexture&&this._modelViewMatricesTexture.dispose()}}const y=new V,_=[];class pe extends ue{constructor(...e){super(...e),this.expandPercent=.25,this.maxInstanceExpansionSize=1/0,this._freeGeometryIds=[]}findFreeId(e,t,a){const n=!!this.geometry.index,c=Math.max(n?e.index.count:-1,a),r=Math.max(e.attributes.position.count,t);let o=-1,d=1/0;const h=this._freeGeometryIds;if(h.forEach((u,l)=>{const C=this.getGeometryRangeAt(u),{reservedIndexCount:T,reservedVertexCount:x}=C;if(T>=c&&x>=r){const M=c-T+(r-x);M<d&&(o=l,d=M)}}),o!==-1){const u=h[o];return h.splice(o,1),u}else return-1}addGeometry(e,t,a){const n=!!this.geometry.index;a=Math.max(n?e.index.count:-1,a),t=Math.max(e.attributes.position.count,t);const{expandPercent:c,_freeGeometryIds:r}=this;let o=this.findFreeId(e,t,a);if(o!==-1)this.setGeometryAt(o,e);else{const d=()=>{const l=this.unusedVertexCount<t,C=this.unusedIndexCount<a;return l||C},h=e.index,u=e.attributes.position;if(t=Math.max(t,u.count),a=Math.max(a,h?h.count:0),d()&&(r.forEach(l=>this.deleteGeometry(l)),r.length=0,this.optimize(),d())){const l=this.geometry.index,C=this.geometry.attributes.position;let T,x;if(l){const M=Math.ceil(c*l.count);T=Math.max(M,a,h.count)+l.count}else T=Math.max(this.unusedIndexCount,a);if(C){const M=Math.ceil(c*C.count);x=Math.max(M,t,u.count)+C.count}else x=Math.max(this.unusedVertexCount,t);this.setGeometrySize(x,T)}o=super.addGeometry(e,t,a)}return o}addInstance(e){if(this.maxInstanceCount===this.instanceCount){const t=Math.ceil(this.maxInstanceCount*(1+this.expandPercent));this.setInstanceCount(Math.min(t,this.maxInstanceExpansionSize))}return super.addInstance(e)}deleteInstance(e){const t=this.getGeometryIdAt(e);return t!==-1&&this._freeGeometryIds.push(t),super.deleteInstance(e)}raycastInstance(e,t,a){const n=this.geometry,c=this.getGeometryIdAt(e);y.material=this.material,y.geometry.index=n.index,y.geometry.attributes=n.attributes;const r=this.getGeometryRangeAt(c);y.geometry.setDrawRange(r.start,r.count),y.geometry.boundingBox===null&&(y.geometry.boundingBox=new j),y.geometry.boundingSphere===null&&(y.geometry.boundingSphere=new $),this.getMatrixAt(e,y.matrixWorld).premultiply(this.matrixWorld),this.getBoundingBoxAt(c,y.geometry.boundingBox),this.getBoundingSphereAt(c,y.geometry.boundingSphere),y.raycast(t,_);for(let o=0,d=_.length;o<d;o++){const h=_[o];h.object=this,h.batchId=e,a.push(h)}_.length=0}}function ge(s){return s.r===1&&s.g===1&&s.b===1}function xe(s){s.needsUpdate=!0,s.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("#include <common>",`
				#include <common>
				varying float texture_index;
				`).replace("#include <uv_vertex>",`
				#include <uv_vertex>
				texture_index = getIndirectIndex( gl_DrawID );
				`),e.fragmentShader=e.fragmentShader.replace("#include <map_pars_fragment>",`
				#ifdef USE_MAP
				precision highp sampler2DArray;
				uniform sampler2DArray map;
				varying float texture_index;
				#endif
				`).replace("#include <map_fragment>",`
				#ifdef USE_MAP
					diffuseColor *= texture( map, vec3( vMapUv, texture_index ) );
				#endif
				`)}}const E=new se(new N),W=new k(new Uint8Array([255,255,255,255]),1,1);W.needsUpdate=!0;class fe{constructor(e={}){if(parseInt(K)<170)throw new Error("BatchedTilesPlugin: Three.js revision 170 or higher required.");e={instanceCount:500,vertexCount:750,indexCount:2e3,expandPercent:.25,maxInstanceCount:1/0,material:null,renderer:null,...e},this.name="BATCHED_MESH_PLUGIN";const t=e.renderer.getContext();this.instanceCount=e.instanceCount,this.vertexCount=e.vertexCount,this.indexCount=e.indexCount,this.material=e.material?e.material.clone():null,this.expandPercent=e.expandPercent,this.maxInstanceCount=Math.min(e.maxInstanceCount,t.getParameter(t.MAX_3D_TEXTURE_SIZE)),this.renderer=e.renderer,this.batchedMesh=null,this.arrayTarget=null,this.tiles=null,this._onLoadModel=null,this._onDisposeModel=null,this._onVisibilityChange=null,this._tileToInstanceId=new Map}init(e){this._onLoadModel=({scene:t,tile:a})=>{const n=[];t.traverse(o=>{o.isMesh&&n.push(o)});let c=!0;n.forEach(o=>{if(this.batchedMesh&&c){const d=o.geometry.attributes,h=this.batchedMesh.geometry.attributes;for(const u in h)if(!(u in d)){c=!1;return}}});const r=!this.batchedMesh||this.batchedMesh.instanceCount+n.length<=this.maxInstanceCount;if(c&&r){a.cached.scene=new q,a.cached.materials=[],a.cached.geometries=[],a.cached.textures=[],t.updateMatrixWorld();const o=[];n.forEach(d=>{this.initBatchedMesh(d);const{geometry:h,material:u}=d,{batchedMesh:l,expandPercent:C}=this;l.expandPercent=C;const T=l.addGeometry(h,this.vertexCount,this.indexCount),x=l.addInstance(T);o.push(x),l.setMatrixAt(x,d.matrixWorld),l.setVisibleAt(x,!1),ge(u.color)||(u.color.setHSL(Math.random(),.5,.5),l.setColorAt(x,u.color));const M=u.map;M?this.assignTextureToLayer(M,x):this.assignTextureToLayer(W,x)}),this._tileToInstanceId.set(a,o)}},this._onDisposeModel=({tile:t})=>{if(this._tileToInstanceId.has(t)){const a=this._tileToInstanceId.get(t);this._tileToInstanceId.delete(t),a.forEach(n=>{this.batchedMesh.deleteInstance(n)})}},this._onVisibilityChange=({tile:t,visible:a})=>{this._tileToInstanceId.has(t)&&this._tileToInstanceId.get(t).forEach(c=>{this.batchedMesh.setVisibleAt(c,a)})},e.addEventListener("load-model",this._onLoadModel),e.addEventListener("dispose-model",this._onDisposeModel),e.addEventListener("tile-visibility-change",this._onVisibilityChange),e.forEachLoadedModel((t,a)=>{this._onLoadModel({scene:t,tile:a})}),this.tiles=e}initBatchedMesh(e){if(this.batchedMesh!==null)return;const{instanceCount:t,vertexCount:a,indexCount:n,tiles:c,renderer:r}=this,o=this.material?this.material:new e.material.constructor,d=new pe(t,t*a,t*n,o);d.name="BatchTilesPlugin",d.frustumCulled=!1,c.group.add(d),d.updateMatrixWorld();const h=e.material.map,u={colorSpace:h.colorSpace,wrapS:h.wrapS,wrapT:h.wrapT,wrapR:h.wrapS,magFilter:h.magFilter},l=new D(h.image.width,h.image.height,t);Object.assign(l.texture,u),r.initRenderTarget(l),o.map=l.texture,xe(o),this.arrayTarget=l,this.batchedMesh=d}assignTextureToLayer(e,t){this.expandArrayTargetIfNeeded();const{renderer:a}=this,n=a.getRenderTarget();a.setRenderTarget(this.arrayTarget,t),E.material.map=e,E.render(a),a.setRenderTarget(n),E.material.map=null,e.dispose()}expandArrayTargetIfNeeded(){const{batchedMesh:e,arrayTarget:t,renderer:a}=this,n=Math.min(e.maxInstanceCount,this.maxInstanceCount);if(n>t.depth){const c={colorSpace:t.texture.colorSpace,wrapS:t.texture.wrapS,wrapT:t.texture.wrapT,generateMipmaps:t.texture.generateMipmaps,minFilter:t.texture.minFilter,magFilter:t.texture.magFilter},r=new D(t.width,t.height,n);Object.assign(r.texture,c),a.initRenderTarget(r),a.copyTextureToTexture(t.texture,r.texture),t.dispose(),e.material.map=r.texture,this.arrayTarget=r}}raycastTile(e,t,a,n){return this._tileToInstanceId.has(e)?(this._tileToInstanceId.get(e).forEach(r=>{this.batchedMesh.raycastInstance(r,a,n)}),!0):!1}dispose(){const{arrayTarget:e,tiles:t,batchedMesh:a}=this;e&&e.dispose(),a&&(a.material.dispose(),a.geometry.dispose(),a.dispose(),a.removeFromParent()),t.removeEventListener("load-model",this._onLoadModel),t.removeEventListener("dispose-model",this._onDisposeModel),t.removeEventListener("tile-visibility-change",this._onVisibilityChange)}}let w,b,f,i,m,P,A;const ye=localStorage.getItem("googleApiKey")??"put-your-api-key-here",p={orthographic:!1,enableCacheDisplay:!1,enableRendererStats:!1,apiKey:ye,useBatchedMesh:!!new URLSearchParams(window.location.hash.replace(/^#/,"")).get("batched"),errorTarget:40,reload:U};Ce();z();function U(){i&&(b.remove(i.group),i.dispose(),i=null),localStorage.setItem("googleApiKey",p.apiKey),i=new oe,i.registerPlugin(new de({apiToken:p.apiKey,autoRefreshToken:!0})),i.registerPlugin(new re),i.registerPlugin(new ne),p.useBatchedMesh?i.registerPlugin(new fe({renderer:f})):i.registerPlugin(new ie),i.group.rotation.x=-Math.PI/2;const s=new ee;s.setDecoderPath("https://unpkg.com/three@0.153.0/examples/jsm/libs/draco/gltf/");const e=new Y(i.manager);e.setDRACOLoader(s),i.manager.addHandler(/\.gltf$/,e),b.add(i.group),i.setResolutionFromRenderer(m.camera,f),i.setCamera(m.camera),w.setTilesRenderer(i)}function Ce(){f=new Q({antialias:!0}),f.setClearColor(1383455),document.body.appendChild(f.domElement),b=new X,m=new ce(new Z(60,window.innerWidth/window.innerHeight,1,16e7),new J(-1,1,1,-1,1,16e7)),m.perspectiveCamera.position.set(48e5,257e4,1472e4),m.perspectiveCamera.lookAt(0,0,0),m.autoSync=!1,m.addEventListener("camera-change",({camera:a,prevCamera:n})=>{i.deleteCamera(n),i.setCamera(a),w.setCamera(a)}),m.orthographicPositionalZoom=!1,w=new le(b,m.camera,f.domElement,null),w.enableDamping=!0,U(),R(),window.addEventListener("resize",R,!1),window.addEventListener("hashchange",v);const s=new te;s.width=300,s.add(p,"orthographic").onChange(a=>{w.getPivotPoint(m.fixedPoint),m.syncCameras(),w.adjustCamera(m.perspectiveCamera),w.adjustCamera(m.orthographicCamera),m.toggle()});const e=s.addFolder("Google Photorealistic Tiles");e.add(p,"apiKey"),e.add(p,"useBatchedMesh").listen(),e.add(p,"reload");const t=s.addFolder("Example Options");t.add(p,"enableCacheDisplay"),t.add(p,"enableRendererStats"),t.add(p,"errorTarget",5,100,1).onChange(()=>{i.getPluginByName("UPDATE_ON_CHANGE_PLUGIN").needsUpdate=!0}),P=document.createElement("div"),document.getElementById("info").appendChild(P),A=new ae,A.showPanel(0),document.body.appendChild(A.dom),v(),setInterval(Me,100)}function R(){const{perspectiveCamera:s,orthographicCamera:e}=m,t=window.innerWidth/window.innerHeight;s.aspect=t,s.updateProjectionMatrix(),e.left=-e.top*t,e.right=-e.left,e.updateProjectionMatrix(),f.setSize(window.innerWidth,window.innerHeight),f.setPixelRatio(window.devicePixelRatio)}function Me(){if(!i)return;const s=m.camera,e={},t={},a=i.group.matrixWorld.clone().invert(),n=s.position.clone().applyMatrix4(a),c=s.matrixWorld.clone().premultiply(a);I.getPositionToCartographic(n,e),I.getAzElRollFromRotationMatrix(e.lat,e.lon,c,t,B),t.azimuth*=g.RAD2DEG,t.elevation*=g.RAD2DEG,t.roll*=g.RAD2DEG,e.lat*=g.RAD2DEG,e.lon*=g.RAD2DEG;const r=new URLSearchParams;r.set("lat",e.lat.toFixed(4)),r.set("lon",e.lon.toFixed(4)),r.set("height",e.height.toFixed(2)),r.set("az",t.azimuth.toFixed(2)),r.set("el",t.elevation.toFixed(2)),r.set("roll",t.roll.toFixed(2)),p.useBatchedMesh&&r.set("batched",1),window.history.replaceState(void 0,void 0,`#${r}`)}function v(){const s=window.location.hash.replace(/^#/,""),e=new URLSearchParams(s);if(e.has("batched")&&(p.useBatchedMesh=!!e.get("batched")),!e.has("lat")&&!e.has("lon"))return;i.group.updateMatrixWorld();const t=m.camera,a=parseFloat(e.get("lat")),n=parseFloat(e.get("lon")),c=parseFloat(e.get("height"))||1e3;if(e.has("az")&&e.has("el")){const r=parseFloat(e.get("az")),o=parseFloat(e.get("el")),d=parseFloat(e.get("roll"))||0;I.getRotationMatrixFromAzElRoll(a*g.DEG2RAD,n*g.DEG2RAD,r*g.DEG2RAD,o*g.DEG2RAD,d*g.DEG2RAD,t.matrixWorld,B),t.matrixWorld.premultiply(i.group.matrixWorld),t.matrixWorld.decompose(t.position,t.quaternion,t.scale),I.getCartographicToPosition(a*g.DEG2RAD,n*g.DEG2RAD,c,t.position),t.position.applyMatrix4(i.group.matrixWorld)}else I.getCartographicToPosition(a*g.DEG2RAD,n*g.DEG2RAD,c,t.position),t.position.applyMatrix4(i.group.matrixWorld),t.lookAt(0,0,0)}function z(){if(requestAnimationFrame(z),!i)return;w.enabled=!m.animating,w.update(),m.update();const s=m.camera;i.setResolutionFromRenderer(s,f),i.setCamera(s),s.updateMatrixWorld(),i.errorTarget=p.errorTarget,i.update(),f.render(b,s),A.update(),we()}function we(){var c;let s="";if(p.enableCacheDisplay){const r=i.lruCache,o=r.cachedBytes/r.maxBytesSize;s+=`Downloading: ${i.stats.downloading} Parsing: ${i.stats.parsing} Visible: ${i.visibleTiles.size}<br/>`,s+=`Cache: ${(100*o).toFixed(2)}% ~${(r.cachedBytes/1e3/1e3).toFixed(2)}mb<br/>`}if(p.enableRendererStats){const r=f.info.memory,o=f.info.render,d=f.info.programs.length;s+=`Geometries: ${r.geometries} Textures: ${r.textures} Programs: ${d} Draw Calls: ${o.calls}`}P.innerHTML!==s&&(P.innerHTML=s);const e=i.group.matrixWorld.clone().invert(),t=m.camera.position.clone().applyMatrix4(e),a={};I.getPositionToCartographic(t,a);const n=((c=i.getAttributions()[0])==null?void 0:c.value)||"";document.getElementById("credits").innerText=he(a.lat,a.lon)+`
`+n}
