import{r as Z,F as J,B as q,a as K}from"./readMagicBytes-Da5ueiou.js";import{L as X}from"./LoaderBase-CVSPpjX2.js";import{j as y,bc as Y,k as g,bd as tt,Q}from"./three.module-DpclfMcJ.js";import{G as et}from"./GLTFLoader-DkJa3Jo5.js";import{E as j}from"./Ellipsoid-Cnb0UTwk.js";const Lt=-1,ht=0,ut=1,gt=2,ft=3,R=6378137,st=1/298.257223563,at=-(st*R-R),nt=1736*1e3,H=1738.1*1e3;class ot extends X{parse(o){const a=new DataView(o),s=Z(a);console.assert(s==="i3dm");const O=a.getUint32(4,!0);console.assert(O===1);const I=a.getUint32(8,!0);console.assert(I===o.byteLength);const S=a.getUint32(12,!0),U=a.getUint32(16,!0),i=a.getUint32(20,!0),f=a.getUint32(24,!0),m=a.getUint32(28,!0),L=32,M=o.slice(L,L+S+U),n=new J(M,0,S,U),e=L+S+U,T=o.slice(e,e+i+f),E=new q(T,n.getData("INSTANCES_LENGTH"),0,i,f),N=e+i+f,h=new Uint8Array(o,N,I-N);let d=null,p=null,b=null;if(m)d=h,p=Promise.resolve();else{const r=this.resolveExternalURL(K(h)),u=r.split(/[\\/]/g);u.pop(),b=u.join("/"),p=fetch(r,this.fetchOptions).then(c=>{if(!c.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${r}" with status ${c.status} : ${c.statusText}`);return c.arrayBuffer()}).then(c=>{d=new Uint8Array(c)})}return p.then(()=>({version:O,featureTable:n,batchTable:E,glbBytes:d,gltfWorkingPath:b}))}}const rt=new j(R,R,at),mt=new j(H,H,nt),W=new g,F=new g,P=new g,C=new g,x=new Q,_=new g,w=new y,V=new y,v=new g,k=new y,B=new Q,G={};class Et extends ot{constructor(o=Y){super(),this.manager=o,this.adjustmentTransform=new y,this.ellipsoid=rt.clone()}resolveExternalURL(o){return this.manager.resolveURL(super.resolveExternalURL(o))}parse(o){return super.parse(o).then(a=>{const{featureTable:s,batchTable:O}=a,I=a.glbBytes.slice().buffer;return new Promise((S,U)=>{const i=this.fetchOptions,f=this.manager,m=f.getHandler("path.gltf")||new et(f);i.credentials==="include"&&i.mode==="cors"&&m.setCrossOrigin("use-credentials"),"credentials"in i&&m.setWithCredentials(i.credentials==="include"),i.headers&&m.setRequestHeader(i.headers);let L=a.gltfWorkingPath??this.workingPath;/[\\/]$/.test(L)||(L+="/");const M=this.adjustmentTransform;m.parse(I,L,n=>{const e=s.getData("INSTANCES_LENGTH"),T=s.getData("POSITION",e,"FLOAT","VEC3"),E=s.getData("NORMAL_UP",e,"FLOAT","VEC3"),N=s.getData("NORMAL_RIGHT",e,"FLOAT","VEC3"),h=s.getData("SCALE_NON_UNIFORM",e,"FLOAT","VEC3"),d=s.getData("SCALE",e,"FLOAT","SCALAR"),p=s.getData("RTC_CENTER"),b=s.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(t=>{t in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${t}" detected.`)});const r=new g;for(let t=0;t<e;t++)r.x+=T[t*3+0]/e,r.y+=T[t*3+1]/e,r.z+=T[t*3+2]/e;const u=[],c=[];n.scene.updateMatrixWorld(),n.scene.traverse(t=>{if(t.isMesh){c.push(t);const{geometry:A,material:D}=t,l=new tt(A,D,e);l.position.copy(r),p&&(l.position.x+=p[0],l.position.y+=p[1],l.position.z+=p[2]),u.push(l)}});for(let t=0;t<e;t++){C.set(T[t*3+0]-r.x,T[t*3+1]-r.y,T[t*3+2]-r.z),x.identity(),E&&(F.set(E[t*3+0],E[t*3+1],E[t*3+2]),P.set(N[t*3+0],N[t*3+1],N[t*3+2]),W.crossVectors(P,F).normalize(),w.makeBasis(P,F,W),x.setFromRotationMatrix(w)),_.set(1,1,1),h&&_.set(h[t*3+0],h[t*3+1],h[t*3+2]),d&&_.multiplyScalar(d[t]);for(let A=0,D=u.length;A<D;A++){const l=u[A];B.copy(x),b&&(l.updateMatrixWorld(),v.copy(C).applyMatrix4(l.matrixWorld),this.ellipsoid.getPositionToCartographic(v,G),this.ellipsoid.getEastNorthUpFrame(G.lat,G.lon,k),B.setFromRotationMatrix(k)),w.compose(C,B,_).multiply(M);const z=c[A];V.multiplyMatrices(w,z.matrixWorld),l.setMatrixAt(t,V)}}n.scene.clear(),n.scene.add(...u),n.batchTable=O,n.featureTable=s,n.scene.batchTable=O,n.scene.featureTable=s,S(n)},U)})})}}export{Lt as F,Et as I,mt as L,gt as P,ht as U,rt as W,ft as a,ut as b};
